<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Transport</title>
  <style>
    body.light-mode { background: #f0f0f0; color: #333; }
    body.light-mode .bloc { background: white; }
    body.dark-mode { background: #121212; color: #f0f0f0; }
    body.dark-mode .bloc { background: #1e1e1e; color: #f0f0f0; }
    body { font-family: Arial, sans-serif; margin: 0; padding: 15px; transition: background 0.5s, color 0.5s; }
    h1 { font-size: 5vw; text-align: center; margin-bottom: 10px; }
    .bloc { border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); word-wrap: break-word; }
    h2 { font-size: 4vw; margin: 0 0 10px; }
    .update-time { font-size: 3vw; color: #888; margin-top: 8px; }
    #toggle-theme { font-size: 1rem; padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; margin-bottom: 10px; }
    body.dark-mode #toggle-theme { background: #444; color: #f0f0f0; }
    body.light-mode #toggle-theme { background: #0077cc; color: white; }
    #debug-log { color: red; font-size: 12px; margin-bottom: 10px; text-align: center; }
    @media (min-width: 600px) { body { padding: 30px; } h1 { font-size: 2rem; } h2 { font-size: 1.5rem; } .update-time { font-size: 0.9rem; } }
  </style>
</head>
<body>
  <h1>üìç Dashboard Transport & Infos Temps R√©el</h1>
  <button id="toggle-theme">üåô Basculer Jour/Nuit</button>
  <div id="debug-log"></div>
  <div id="current-time" class="bloc">üïí Chargement...</div>

  <div class="bloc">
    <h2>üöÜ RER A ‚Äì Joinville-le-Pont</h2>
    <div id="rer-joinville">Chargement...</div>
    <div id="rer-joinville-update" class="update-time"></div>
  </div>

  <div class="bloc">
    <h2>üöå Bus 77 ‚Äì Hippodrome</h2>
    <div id="bus77-hippo">Chargement...</div>
    <div id="bus77-hippo-update" class="update-time"></div>
  </div>

  <div class="bloc">
    <h2>üöå Bus 201 ‚Äì √âcole du Breuil</h2>
    <div id="bus201-breuil">Chargement...</div>
    <div id="bus201-breuil-update" class="update-time"></div>
  </div>

  <script>
    // Th√®me auto + bouton bascule
    function applyTheme(theme) {
      document.body.classList.remove("light-mode", "dark-mode");
      document.body.classList.add(theme + "-mode");
      localStorage.setItem("theme", theme);
    }
    function autoDetectTheme() {
      const hour = new Date().getHours();
      return (hour >= 20 || hour < 7) ? "dark" : "light";
    }
    const savedTheme = localStorage.getItem("theme");
    applyTheme(savedTheme || autoDetectTheme());
    document.getElementById("toggle-theme").addEventListener("click", () => {
      const current = document.body.classList.contains("light-mode") ? "light" : "dark";
      applyTheme(current === "light" ? "dark" : "light");
    });

    // Logger d'erreurs
    function logError(msg) {
      const log = document.getElementById("debug-log");
      if (log) log.textContent = msg;
      console.error(msg);
    }

    // Reste de ton script (seulement les appels et fonctions de base pour exemple) :
    async function fetchRealTime(stopAreaId) {
      try {
        const url = `https://ratp-proxy.hippodrome-proxy42.workers.dev/?url=https://prim.iledefrance-mobilites.fr/marketplace/stop-monitoring?MonitoringRef=${stopAreaId}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Erreur API ${res.status}`);
        const data = await res.json();
        return data?.Siri?.ServiceDelivery?.StopMonitoringDelivery?.[0]?.MonitoredStopVisit || [];
      } catch (e) {
        logError(`Erreur fetchRealTime : ${e.message}`);
        return [];
      }
    }

    async function updateStop(elementId, stopIds) {
      try {
        let tripsText = "";
        for (const stopId of stopIds) {
          const trips = await fetchRealTime(stopId);
          tripsText += trips.length ? trips.map(t => t.MonitoredVehicleJourney?.MonitoredCall?.ExpectedDepartureTime).join("<br>") : "‚ùå Aucun passage.<br>";
        }
        document.getElementById(elementId).innerHTML = tripsText;
      } catch (e) {
        logError(`Erreur updateStop : ${e.message}`);
      }
    }

    function updateGlobalDateTime() {
      const el = document.getElementById("current-time");
      if (el) {
        const now = new Date();
        el.textContent = `üïí ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
      }
    }

    async function refreshAll() {
      try {
        updateGlobalDateTime();
        await Promise.all([
          updateStop("rer-joinville", ["STIF:StopPoint:Q:39406:"]),
          updateStop("bus77-hippo", ["STIF:StopPoint:Q:463640:", "STIF:StopPoint:Q:463647:"]),
          updateStop("bus201-breuil", ["STIF:StopPoint:Q:463646:", "STIF:StopPoint:Q:463643:"])
        ]);
      } catch (e) {
        logError(`Erreur refreshAll : ${e.message}`);
      }
    }
    refreshAll();
    setInterval(refreshAll, 5 * 60 * 1000);
  </script>
</body>
</html>